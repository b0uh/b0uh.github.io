<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Thomas Loiret">
  <meta name="description" content="How to deploy a Django project on Clever Cloud ?">

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@b0uh" />
    <meta name="twitter:title" content="Create and deploy a Django project on Clever Cloud - Thomas Loiret - Random thoughts" />
    <meta name="twitter:description" content="How to deploy a Django project on Clever Cloud ?" />

  <meta name="google-site-verification" content="jZBc2U9MHiBnSlgpoFEed-V3PZ16pMNv0GSX4hOh4mg" />

  <title>Create and deploy a Django project on Clever Cloud - Thomas Loiret - Random thoughts</title>

  <!-- Custom styles for this template -->
  <!-- build:css stylesheets/main.css -->
  <link rel="stylesheet" href="https://b0uh.github.io/theme/css/main.css">
  <link rel="stylesheet" href="https://b0uh.github.io/theme/css/custom.css">
  <link rel="stylesheet" href="https://b0uh.github.io/theme/css/pygments/autumn.css">
  <!-- endbuild -->

  <link href="https://b0uh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Thomas Loiret - Random thoughts Atom Feed" />

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->

  <!-- Google Fonts -->
  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Open+Sans:300,400,700:latin', 'Lato:700,900:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
  </script>
</head>

<body>
<!-- header -->
<header class="header  push-down-45">
  <div class="container">

    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#readable-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <nav class="navbar  navbar-default" role="navigation">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse  navbar-collapse" id="readable-navbar-collapse">
        <ul class="navigation">

          <li>
            <a href="https://b0uh.github.io">Home</a>
          </li>

            <li>
              <a href="https://b0uh.github.io/pages/about.html">About</a>
            </li>

          <li>
            <a href="https://b0uh.github.io/archives.html">Archives</a>
          </li>

        </ul>
      </div><!-- /.navbar-collapse -->
    </nav>

    <div class="hidden-xs  hidden-sm">
      <div class="social">
        <a href="#" class="search__container">
          <span class="glyphicon  glyphicon-flash"></span>
        </a>
        <ul class="social__dropdown">
            <li>
              <a href="https://b0uh.github.io/feeds/all.atom.xml" target="_blank" class="social__container">
                <span class="zocial-rss"></span>
              </a>
            </li>
          <li>
            <a href="https://twitter.com/b0uh" target="_blank" class="social__container">
              <span class="zocial-twitter"></span>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/in/thomasloiret/" target="_blank" class="social__container">
              <span class="zocial-linkedin"></span>
            </a>
          </li>
          <!-- <li>
            <a href="https://www.malt.fr/profile/thomasloiret" target="_blank" class="social__container">
              <img src="https://b0uh.github.io/theme/images/icons/malt-25px.png" />
            </a>
          </li> -->
          <li>
            <a href="https://www.last.fm/user/b0uh" target="_blank" class="social__container">
              <span class="zocial-lastfm"></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</header>

<div class="container">

      <div itemscope itemtype="http://schema.org/Article" class="boxed push-down-60">


        <!-- Start of the blogpost -->
        <div class="row">
          <div class="col-xs-10  col-xs-offset-1  col-md-8  col-md-offset-2  push-down-60">

            <!-- Start of the content -->
            <div class="post-content">

              <h1 itemprop="name">Create and deploy a Django project on Clever Cloud</h1>

              <div class="meta__container--without-image">
                <div class="row">
                  <div class="col-xs-12  col-sm-8">
                    <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                      <div class="meta__info" itemprop="name">
                        Thomas Loiret
                      </div>
                    </span>
                  </div>
                  <div class="col-xs-12  col-sm-4">
                    <div class="meta__comments">
                      <span class="meta__date" itemprop="datePublished" content="2018-01-25">
                        <span class="glyphicon glyphicon-calendar"></span>  &nbsp; Thu 25 January 2018
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <span itemprop="articleBody">
                <p><strong>Last update:</strong> 15/10/2019
<br>
<br></p>
<p>In this blog post, we will see how to host a new Django project on Clever Cloud (<a href="https://www.clever-cloud.com/">www.clever-cloud.com</a>). If you don't have a Clever Cloud account, you can signup and you will get a 20â‚¬ credit to test the platform ;)</p>
<h1>1/ Create a Django project</h1>
<div class="highlight"><pre><span></span><code>$ django-admin startproject fooproject
$ <span class="nb">cd</span> fooproject
$ <span class="nb">echo</span> <span class="s2">&quot;Django&quot;</span> &gt; requirements.txt
$ git init
$ git add .
$ git commit -m <span class="s2">&quot;initial commit&quot;</span>
</code></pre></div>


<p>For more information, please take a look at the wonderful <a href="https://docs.djangoproject.com/">Django's documentation</a>.</p>
<p><strong>Note</strong>: currently Clever Cloud does not support <code>pipenv</code> wonderful <code>Pipfile</code> &amp; <code>Pipfle.lock</code> files. The traditional <code>requirements.txt</code> is required.</p>
<h1>2/ Create the application on Clever Cloud</h1>
<ol>
<li>Create a new application (Personal Space &gt; Add an application)</li>
<li>Create a brand new app</li>
<li>Choose Python</li>
<li>At the scaling step, choose what you want, if you don't know, just use the default settings</li>
<li>Name your application, mine will by "Foo project"</li>
<li>No need for an add-on for now.</li>
</ol>
<p>And that's it !</p>
<h1>3/ Deploy your application</h1>
<p>Go to the <em>Information</em> section for your application and at the top you should see a line starting by
<code>git remote add ...</code>, copy it. It may be one two lines actually if you have a small screen, eg. 13".</p>
<p>On your project you should do something like this (it's an example):</p>
<div class="highlight"><pre><span></span><code>$ git remote add clever git+ssh://git@push-par-clevercloud-customers.services.clever-cloud.com/app_b8faacf4-7a4a-4b95-8221-7cb85e46cd82.git
$ git push clever master
</code></pre></div>


<p>Come back to your Clever cloud dashboard and go to the <em>Logs</em> section and see your application deploying :) (You may want to scroll down to see the latest logs)</p>
<p>And you have done your first deploy !</p>
<h1>4/ But the deployment failed :(</h1>
<p>We missed some steps to ensure that the deploy run smoothly, mainly configuration steps. We need to specify the module to load, by adding the following file <code>clevercloud/python.json</code> in our project (replace <code>fooproject</code> by your project):</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;deploy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;fooproject.wsgi:application&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Also, because you should not use <a href="https://www.python.org/doc/sunset-python-2/">python 2</a>, go to the <em>Environment variables</em> section of your application and add the following variable:</p>
<div class="highlight"><pre><span></span><code><span class="nv">PYTHON_VERSION</span><span class="o">=</span><span class="s2">&quot;3&quot;</span>
</code></pre></div>


<p>Then redeploy your application. At this point you should have a running application! Go see your application by using the link at the top corner right of the dashboard or go to http://&lt;your_application_id>.cleverapps.io/</p>
<p>You will have a <code>DisallowedHost</code> error but at least your application is running! We need to configure a bit Django by adding the following to the <code>fooproject/settings.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;APP_ID&gt;.cleverapps.io&#39;</span><span class="p">,</span> <span class="p">]</span>
</code></pre></div>


<p>Commit and push your new settings file, a new deploy should be triggered. You should now have a deployed and running application!</p>
<p><img class="wp-post-image" alt="Django deploy screen" src="https://b0uh.github.io/medias/clever-cloud-django-deploy.gif"></p>
<h1>5/ Use a database</h1>
<ol>
<li>On Clever cloud dashboard, click on <em>Add an add-on</em></li>
<li>Select <em>PostgreSQL</em></li>
<li>Select <em>DEV</em> plan, you will be able to change of plan later if needed</li>
<li>Link your add-on to your application</li>
<li>Give a name to your database</li>
</ol>
<p>In your <code>settings.py</code> you can update your database credentials by using the following environment variables.</p>
<div class="highlight"><pre><span></span><code><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.postgresql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;POSTGRESQL_ADDON_DB&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;POSTGRESQL_ADDON_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;POSTGRESQL_ADDON_PASSWORD&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;POSTGRESQL_ADDON_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;POSTGRESQL_ADDON_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Don't forget to add the <code>psycopg2</code> package to your <code>requirements.txt</code> file.</p>
<p>Commit those changes and push them in order to deploy again your application.</p>
<h1>6/ Manage your static and medias files</h1>
<blockquote>
<p>It is important to understand that the notion of "static" files is different between Clever cloud and Django!</p>
<p>In Django there is a difference between the file uploaded with the project (static files) and the file uploaded by the users (media files) but for Clever cloud static files are all the files you want to serve statically.</p>
</blockquote>
<p>In Django' settings add:</p>
<div class="highlight"><pre><span></span><code><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s1">&#39;/public/static/&#39;</span>
<span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="s1">&#39;/public/media/&#39;</span>
<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;public/media&#39;</span><span class="p">)</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;public/static&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Locally create the directory <code>public</code> at the root of the project. Add a dummy hidden file (<code>.keep_this_dir</code> for example) in order the create this directory during the build on clever cloud.</p>
<p>For media files create a new add-on "FS Bucket" on which your media files will be saved:</p>
<ol>
<li>On the dashboard, click on <em>Add an add-on</em></li>
<li>Select <em>FS Buckets</em></li>
<li>Select <em>basic</em> plan</li>
<li>Link your add-on to your application</li>
<li>Give a name to your add-on</li>
</ol>
<p>And then, in the app dashboard add the following environment variables:</p>
<div class="highlight"><pre><span></span><code><span class="nv">STATIC_FILES_PATH</span><span class="o">=</span><span class="s2">&quot;public/&quot;</span>
<span class="nv">STATIC_URL_PREFIX</span><span class="o">=</span><span class="s2">&quot;/public&quot;</span>
<span class="nv">CC_FS_BUCKET</span><span class="o">=</span><span class="s2">&quot;/public/media:&lt;BUCKET_ID&gt;-fsbucket.services.clever-cloud.com&quot;</span>
</code></pre></div>


<p>Redeploy and you now have a Django project with your media files handled.</p>
<h1>7/ Continuous integration</h1>
<p>We are still missing something to fully use our two addons. We need to do migrations to create the DB schema and we need to collect the static. To automatize those tasks after each new deployments we will use the <code>clevercloud/python.json</code> file and add a <code>managetasks</code> entry.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;deploy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;fooproject.wsgi:application&quot;</span><span class="p">,</span>
        <span class="nt">&quot;managetasks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;migrate --no-input&quot;</span><span class="p">,</span>
            <span class="s2">&quot;collectstatic --noinput&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Note: Another way to handle that is to use <a href="https://www.clever-cloud.com/doc/clever-cloud-overview/hooks/">hooks</a> that are more documented and seems more flexible.</p>
<h1>8/ Create a super user</h1>
<p>Go to <em>Profile</em> then <em>SSH Key</em> and add your SSH key. After that you can ssh the server and create the super user.</p>
<div class="highlight"><pre><span></span><code>$ ssh -t ssh@sshgateway-clevercloud-customers.services.clever-cloud.com &lt;APP_ID&gt;
$ <span class="nb">cd</span> &lt;APP_ID&gt;/
$ ./manage.py createsuperuser
</code></pre></div>


<p>This should be the only time you need to connect through SSH to Clever Cloud. Please keep in mind that you should avoid SSH access as much as possible for security reasons.</p>
<h1>Conclusion</h1>
<p>I hope you have managed to deploy your own Django project on Clever Cloud. The service is really smooth and easy to use, congratz to the team!</p>
              </span>

              <div class="meta__container--without-image">
                <div class="row">
                </div>
              </div>

              <br>
            </div>
          </div>
        </div>
      </div>

</div>

<footer class="copyrights">
  <div class="container">
    <div class="row">
      <div class="col-xs-12  col-sm-6">
        Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>.
      </div>
      <div class="col-xs-12  col-sm-6">
        <div class="copyrights--right">
          Made with <span class="glyphicon  glyphicon-heart"></span> in Nantes.
        </div>
      </div>
    </div>
  </div>
</footer>

  <script src="https://b0uh.github.io/theme/scripts/jquery.min.js"></script>
  <script src="https://b0uh.github.io/theme/scripts/underscore.js"></script>
  <script src="https://b0uh.github.io/theme/scripts/bootstrap.min.js"></script>
  <script src="https://b0uh.github.io/theme/scripts/main.js"></script>


  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-98369697-1', 'auto');
    ga('send', 'pageview');

  </script>

</body>
</html>